<!DOCTYPE html>
<html>
<head>
    <title>è¶…å•†åˆ†å±¤åœ°åœ–</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
       integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
       crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
       integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
       crossorigin=""></script>

    <style>
        /* éŸ¿æ‡‰å¼åœ°åœ–æ¨£å¼ */
        #map {
            height: 600px;
            width: 100%;
        }
        
        /* æ‰‹æ©Ÿæœ€ä½³åŒ– */
        @media (max-width: 768px) {
            #map {
                height: 100vh; 
            }
            html, body {
                height: 100%;
                margin: 0; 
                padding: 0;
            }
        }
        
        /* è‡ªè¨‚å®šä½æŒ‰éˆ•çš„æ¨£å¼ (å»¶ç”¨ä¸Šä¸€å€‹ç‰ˆæœ¬) */
        .leaflet-control-locate a {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="%23333" d="M16 4c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10zm0 3c-3.866 0-7 3.134-7 7s3.134 7 7 7 7-3.134 7-7-3.134-7-7-7zm0 2c2.761 0 5 2.239 5 5s-2.239 5-5 5-5-2.239-5-5 2.239-5 5-5z"/></svg>');
            background-size: 26px 26px;
            background-position: 50% 50%;
            background-repeat: no-repeat;
            display: block;
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // =================================================================
        // ğŸŒŸğŸŒŸğŸŒŸ  è¶…ç´šæ–¹ä¾¿æ‰“é»å€ ğŸŒŸğŸŒŸğŸŒŸ
        // æ‚¨åªéœ€ä¿®æ”¹é€™å€‹é™£åˆ—å³å¯æ–°å¢ã€åˆªé™¤æˆ–ä¿®æ”¹æ‰“é»
        // æ ¼å¼ï¼š[ç·¯åº¦, ç¶“åº¦, 'åç¨±', 'åœ–å±¤åç¨± (å…¨å®¶/7-11)', 'å½ˆå‡ºè¦–çª—å…§å®¹']
        // =================================================================
        const STORE_DATA = [
            // å…¨å®¶ä¾¿åˆ©å•†åº— (FamilyMart)
            [25.0478, 121.5160, 'å…¨å®¶åŒ—è»Šåº—', 'å…¨å®¶', 'æœ€è¿‘çš„ç«è»Šç«™å‡ºå£'],
            [25.0450, 121.5205, 'å…¨å®¶è¯å±±åº—', 'å…¨å®¶', 'é è¿‘è¯å±±æ–‡å‰µåœ’å€'],
            
            // 7-11 ä¾¿åˆ©å•†åº—
            [25.0485, 121.5175, '7-11æ·é‹åº—', '7-11', 'æ·é‹å‡ºå£æ—çš„ 7-11'],
            [25.0490, 121.5155, '7-11å…¬åœ’åº—', '7-11', 'é™„è¿‘æœ‰å…¬åœ’'],
            
            // æ‚¨å¯ä»¥è‡ªè¡Œæ–°å¢æ›´å¤šæ‰“é»ï¼Œä¾‹å¦‚ï¼š
            // [25.033, 121.565, '7-11å¸‚åºœåº—', '7-11', 'å¸‚æ”¿åºœé™„è¿‘çš„ 7-11']
        ];
        // =================================================================
        // ğŸŒŸğŸŒŸğŸŒŸ  çµæŸæ‰“é»å€  ğŸŒŸğŸŒŸğŸŒŸ
        // =================================================================

        // é è¨­ä½ç½®ï¼šå°åŒ—ç«è»Šç«™
        const TAIPEI_STATION_COORD = [25.0477, 121.5170];
        const INITIAL_ZOOM = 15;
        
        let currentLocationMarker;
        let accuracyCircle;

        // 1. åˆå§‹åŒ–åœ°åœ–
        const map = L.map('map', {
            center: TAIPEI_STATION_COORD,
            zoom: INITIAL_ZOOM,
            zoomControl: true 
        });

        // 2. åŠ å…¥ OpenStreetMap åœ–å±¤
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);


        // 3. å‰µå»ºåœ–å±¤ç¾¤çµ„ (Layer Groups)
        const familyMartGroup = L.layerGroup();
        const sevenElevenGroup = L.layerGroup();

        // 4. æ ¹æ“š STORE_DATA é™£åˆ—å‹•æ…‹æ–°å¢æ‰“é»
        STORE_DATA.forEach(data => {
            const [lat, lng, name, layerName, popupContent] = data;
            const marker = L.marker([lat, lng], {
                title: name // æ¨™é¡Œä½œç‚ºæ»‘é¼ æ‡¸åœæç¤º
            }).bindPopup(`<b>${name}</b><br>${popupContent}`);

            if (layerName === 'å…¨å®¶') {
                marker.addTo(familyMartGroup);
            } else if (layerName === '7-11') {
                marker.addTo(sevenElevenGroup);
            }
        });
        
        // é è¨­å°‡å…©å€‹åœ–å±¤éƒ½åŠ å…¥åœ°åœ–ä¸­
        familyMartGroup.addTo(map);
        sevenElevenGroup.addTo(map);


        // 5. åŠ å…¥åœ–å±¤æ§åˆ¶é …
        // åº•åœ– (Base Layers) - é€™è£¡åªæœ‰ OSM ä¸€å±¤
        const baseLayers = {
            "OpenStreetMap": osmLayer
        };

        // è¦†è“‹åœ–å±¤ (Overlay Layers) - æˆ‘å€‘çš„æ‰“é»ç¾¤çµ„
        const overlayLayers = {
            "ğŸª å…¨å®¶ (FamilyMart)": familyMartGroup,
            "ğŸª 7-11": sevenElevenGroup
        };
        
        // å°‡åœ–å±¤æ§åˆ¶é …åŠ å…¥åœ°åœ– (é€šå¸¸ä½æ–¼å³ä¸Šè§’)
        L.control.layers(baseLayers, overlayLayers, {
            collapsed: false // é è¨­å±•é–‹åœ–å±¤åˆ—è¡¨ (å¯è¨­ç‚º true éš±è—)
        }).addTo(map);


        // --- å®šä½åŠŸèƒ½å¯¦ä½œ (ä¿ç•™ä¸Šä¸€å€‹ç‰ˆæœ¬çš„åŠŸèƒ½) ---

        function onLocationFound(e) {
            const radius = e.accuracy;
            const latlng = e.latlng;
            
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
            }

            currentLocationMarker = L.marker(latlng).addTo(map)
                .bindPopup("æ‚¨ç›®å‰çš„ä½ç½®ï¼Œèª¤å·®ç´„ " + radius.toFixed(0) + " å…¬å°º").openPopup();

            accuracyCircle = L.circle(latlng, radius, {
                color: 'blue',
                fillColor: '#30f',
                fillOpacity: 0.1,
                weight: 1
            }).addTo(map);

            map.setView(latlng, Math.min(map.getZoom(), 16));
        }

        function onLocationError(e) {
            console.error(e.message);
            alert("ç„¡æ³•å–å¾—æ‚¨çš„åœ°ç†ä½ç½®ã€‚\néŒ¯èª¤è¨Šæ¯: " + e.message + "\nåœ°åœ–å°‡é¡¯ç¤ºå°åŒ—ç«è»Šç«™ã€‚");
            map.setView(TAIPEI_STATION_COORD, INITIAL_ZOOM);
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // è‡ªè¨‚å®šä½æ§åˆ¶æŒ‰éˆ•
        const LocateControl = L.Control.extend({
            options: {
                position: 'topleft'
            },
            onAdd: function (map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');
                const link = L.DomUtil.create('a', '', container);
                link.href = '#';
                link.title = 'å®šä½åˆ°æ‚¨çš„ä½ç½®';
                link.role = 'button';
                L.DomEvent.on(link, 'click', L.DomEvent.stop)
                          .on(link, 'click', function () {
                              map.locate({setView: true, maxZoom: 16});
                          });
                return container;
            }
        });
        map.addControl(new LocateControl());

        // ç¶²é é–‹å•Ÿæ™‚çš„åˆå§‹å®šä½è«‹æ±‚
        map.locate({
            setView: true,
            maxZoom: 16,   
            watch: false,  
            enableHighAccuracy: true
        });

    </script>

</body>
</html>
